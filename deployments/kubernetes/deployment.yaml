---
# ConfigMap containing Sentinel configuration
# This demonstrates how to deploy Sentinel configuration in Kubernetes
apiVersion: v1
kind: ConfigMap
metadata:
  name: sentinel-config
  namespace: hyperfleet-system
data:
  config.yaml: |
    # Sentinel configuration for production deployment
    resource_type: clusters
    poll_interval: 5s
    backoff_not_ready: 10s
    backoff_ready: 30m

    # Shard selector for horizontal scaling
    # Deploy multiple Sentinel instances with different shard values
    resource_selector:
      - label: shard
        value: "1"

    # HyperFleet API configuration
    hyperfleet_api:
      # Use in-cluster service name for API endpoint
      endpoint: http://hyperfleet-api.hyperfleet-system.svc.cluster.local:8080
      timeout: 30s

    # CloudEvents data payload configuration
    message_data:
      resource_id: .id
      resource_type: .kind
      resource_name: .metadata.name
      generation: .generation

---
# Secret containing broker credentials
# WARNING: Never commit real credentials to git!
# This is a template - replace values with actual credentials or use external secrets management
# (e.g., External Secrets Operator, Sealed Secrets, or Vault)
apiVersion: v1
kind: Secret
metadata:
  name: sentinel-broker-credentials
  namespace: hyperfleet-system
type: Opaque
stringData:
  # For RabbitMQ
  BROKER_TYPE: "rabbitmq"
  BROKER_HOST: "rabbitmq.hyperfleet-system.svc.cluster.local"
  BROKER_PORT: "5672"
  BROKER_EXCHANGE: "hyperfleet-events"
  BROKER_VHOST: "/hyperfleet"
  BROKER_EXCHANGE_TYPE: "fanout"
  RABBITMQ_USERNAME: "sentinel-user"
  RABBITMQ_PASSWORD: "change-me-in-production"

  # For GCP Pub/Sub (alternative to RabbitMQ)
  # BROKER_TYPE: "pubsub"
  # BROKER_PROJECT_ID: "your-gcp-project-id"

  # For AWS SQS (alternative to RabbitMQ)
  # BROKER_TYPE: "awsSqs"
  # BROKER_REGION: "us-east-1"
  # BROKER_QUEUE_URL: "https://sqs.us-east-1.amazonaws.com/123456789012/hyperfleet-events"

---
# Deployment for Sentinel service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sentinel
  namespace: hyperfleet-system
  labels:
    app: sentinel
    component: sentinel
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sentinel
  template:
    metadata:
      labels:
        app: sentinel
    spec:
      serviceAccountName: sentinel
      containers:
      - name: sentinel
        # NOTE: Using :latest tag is not recommended for production.
        # Use a specific version tag (e.g., :v1.0.0) for production deployments.
        image: quay.io/hyperfleet/sentinel:latest
        imagePullPolicy: Always
        args:
          - serve
          - --config=/etc/sentinel/config.yaml
        env:
          # Broker credentials from Secret
          - name: BROKER_TYPE
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: BROKER_TYPE
          - name: BROKER_HOST
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: BROKER_HOST
          - name: BROKER_PORT
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: BROKER_PORT
          - name: BROKER_EXCHANGE
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: BROKER_EXCHANGE
          - name: BROKER_VHOST
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: BROKER_VHOST
                optional: true
          - name: BROKER_EXCHANGE_TYPE
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: BROKER_EXCHANGE_TYPE
                optional: true
          - name: RABBITMQ_USERNAME
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: RABBITMQ_USERNAME
                optional: true
          - name: RABBITMQ_PASSWORD
            valueFrom:
              secretKeyRef:
                name: sentinel-broker-credentials
                key: RABBITMQ_PASSWORD
                optional: true
        volumeMounts:
          # Mount ConfigMap as config file
          - name: config
            mountPath: /etc/sentinel
            readOnly: true
        resources:
          # NOTE: Adjust these resource limits based on your workload.
          # Monitor actual usage and tune accordingly.
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
      volumes:
        # Volume from ConfigMap
        - name: config
          configMap:
            name: sentinel-config

---
# ServiceAccount for Sentinel
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sentinel
  namespace: hyperfleet-system
  # For GCP Pub/Sub with Workload Identity
  # annotations:
  #   iam.gke.io/gcp-service-account: sentinel@your-project.iam.gserviceaccount.com
  # For AWS SQS with IRSA
  # annotations:
  #   eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/sentinel-role
